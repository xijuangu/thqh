## 第一部分：每日巡检 (耗时约 15-20 分钟)

> **目标：** 确保所有服务器核心服务存活，关键数据同步无误。 

所有维护工作都只需要在生产环境进行

### 1. 客户账户分析小程序 (核心)

**📍 目标服务器：** `172.18.26.170` (生产) / `171.16.10.131` (测试)，需要在内网机器上连接

**🔑 关键端口：** MySQL(3306), Redis(6379), Java(8080/8083), DataX(9527/9999)

| 步骤 | 操作项               | 命令/操作                                                    | 正常标准                                          | 异常处理                                             |
| ---- | -------------------- | ------------------------------------------------------------ | ------------------------------------------------- | ---------------------------------------------------- |
| 1.1  | **检查服务进程**     | `netstat -tulnp | grep -E '3306|6379|8080|8083|9527|9999'`   | 所有端口均有 `java` 或 `LISTEN` 状态              | 如果发现服务有异常，根据情况重启或 kill 掉再启动即可 |
| 1.2  | **检查数据同步状态** | 1. Navicat 连接 `172.18.26.170` (root)<br>2. 进入 `thqh` 库，查询 `SyncStateTable` | `checkFlag=1` 的记录，其 `syncstate` 必须为 **0** | 参照 **监控与错误处理** 进行处理                     |
| 1.3  | **检查文件传输日志** | `tail -n 40 /usr/local/Thqh/rsyncData/rsync_log/rsync_data.log` | 日志最后显示传输成功，**无“传输失败”** 字样       | 参照 **监控与错误处理** 进行处理                     |

> 注意，第三步中的文件路径 `/usr/local/Thqh/rsyncData/` 这部分路径取自 `thqh` 库中的 `Loaction` 表中的字段的路径的上一级目录，`Location` 表用于定义数据处理程序生成的增量、全量CSV文件的存放路径，以及控股数仓推送过来的CSV文件的存放路径。数据处理程序生成的增量、全量CSV文件的存放路径可以自行定义，控股数仓推送过来的CSV文件的存放路径一般不轻易修改，若需要修改需要与控股数仓相关开发/维护人员提前协调新的推送路径。

172.18.26.170 上的 jar 包位置：

| 服务概述                                                     | jar包位置                                                    | 运行端口 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- |
| 数据处理服务：数据脱敏、csv文件生成、接收csv文件的持久化、数据一致性检查 | /usr/local/my/ProcessServer-0.0.1-SNAPSHOT.jar               | 8083     |
| 小程序后端：处理用户微信号/手机号授权登录、交易账号验证、账户分析报表查询请求 | /usr/local/wxServer/wechat_miniprogram_backend-0.0.1-SNAPSHOT.jar | 8080     |
| 看板后端：处理看板网页查询请求                               | /usr/local/wxServer/wechat_miniprogram_management_backend-0.0.1-SNAPSHOT.jar |          |

其余端口上的服务：

| 服务          | 端口        |
| ------------- | ----------- |
| mysql         | 3306        |
| redis         | 6379        |
| datax同步工具 | 9527 / 9999 |

### 2. 碳酸锂指数发布

**📍 目标服务器：** `172.17.10.223`，在外网机器上连接
**🔑 关键端口：** MySQL(3306), Java(8081/8082), Nginx(8080/8083)

| 步骤 | 操作项           | 命令/操作                                             | 正常标准                | 异常处理 |
| ---- | ---------------- | ----------------------------------------------------- | ----------------------- | -------- |
| 2.1  | **检查服务进程** | `netstat -tulnp | grep -E '3306|8081|8082|8080|8083'` | 所有端口均处于 `LISTEN` |          |

172.17.10.223 上的 jar 包位置：

| 服务概述                                                     | jar包位置                                               | 运行端口 |
| ------------------------------------------------------------ | ------------------------------------------------------- | -------- |
| 碳酸锂指数发布（管理侧）后端：处理碳酸锂数据管理平台的xlsx数据文件上传请求 | /usr/local/my/server/lightDataServer-0.0.1-SNAPSHOT.jar | 8082     |
| 碳酸锂指数发布（用户侧）后端：处理碳酸锂数据发布网页的数据拉取请求 | /usr/local/my/server/lightServer-0.0.1-SNAPSHOT.jar     | 8081     |

其余端口上的服务：

| 服务  | 端口        |
| ----- | ----------- |
| mysql | 3306        |
| nginx | 8080 / 8083 |

> 其中 8080 是对内网提供的端口号，且默认不转发请求到后端，所以数据是空的，27878 是对外网提供的，会转发请求，所以可以看到数据。并且请求必须通过域名访问，也就是说 https://service.thqh.com.cn:27878/index_web/ 才是能正常访问的页面

### 3. 企微会话存档 (高风险)

**📍 目标服务器：** `172.17.10.202` (核心数据) / `172.17.10.108` (代理)，在外网机器上连接，只需要在 202 上操作即可
**🔑 关键端口：** MinIO(9000), MySQL(3306), Redis(6379), Java(8081)

| 步骤 | 操作项           | 命令/操作                                        | 正常标准                 | 异常处理                              |
| ---- | ---------------- | ------------------------------------------------ | ------------------------ | ------------------------------------- |
| 3.1  | **检查服务进程** | `netstat -tulnp | grep -E '3306|6379|9000|8081'` | 所有端口均处于 `LISTEN`  | 参见文末“故障重启指南”                |
| 3.2  | **检查MinIO**    | 浏览器访问 `http://172.17.10.202:9001`           | 能用 `myminioadmin` 登录 | 检查 `systemctl status minio.service` |

172.17.10.202 上的 jar 包位置：

| 服务概述                                                     | jar包位置                                                    | 运行端口 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- |
| 处理系统用户登录、前台数据查询请求；定时从企微云端拉取会话存档数据到项目数据库 | /usr/local/my/EWC_server/enterprise_wechat_backend-0.0.1-SNAPSHOT.jar | 8081     |

其余端口上的服务：

| 服务  | 端口        |
| ----- | ----------- |
| mysql | 3306        |
| redis | 6379        |
| MinIO | 9000 / 9001 |

> MinIO 中，9000 是存储服务的端口，9001 是管理页面的端口。

### 4. 业务数据展示系统

**📍 目标服务器：** `172.18.26.59`，需从内网访问
**🔑 关键端口：** MySQL(3306), Java(8080), DataX(9527/9999), Nginx(8081)

| 步骤 | 操作项           | 命令/操作                                             | 正常标准                | 异常处理               |
| ---- | ---------------- | ----------------------------------------------------- | ----------------------- | ---------------------- |
| 4.1  | **检查服务进程** | `netstat -tulnp | grep -E '3306|8080|8081|9527|9999'` | 所有端口均处于 `LISTEN` | 参见文末“故障重启指南” |

172.18.26.59 上的 jar 包位置：

| 项目             | 服务概述                                                   | jar包位置                                       |
| ---------------- | ---------------------------------------------------------- | ----------------------------------------------- |
| 业务数据展示系统 | 处理前台数据查询、客户类维护、系统用户、角色权限管理等请求 | /usr/local/my/jar/BDDSServer-0.0.1-SNAPSHOT.jar |

其余端口上的服务：

| 服务          | 端口        |
| ------------- | ----------- |
| mysql         | 3306        |
| datax同步工具 | 9527 / 9999 |
| nginx         | 8081        |

### 5. 统计看板

**📍 目标服务器：** `172.18.26.173`，需从内网访问
**🔑 关键端口：** Nginx(8081)

| 步骤 | 操作项        | 命令/操作                           | 正常标准               | 异常处理   |
| ---- | ------------- | ----------------------------------- | ---------------------- | ---------- |
| 5.1  | **检查Nginx** | `curl -I http://172.18.26.173:8081` | 返回 `HTTP/1.1 200 OK` | 重启 Nginx |



## 第二部分：每周任务 (周一上午建议执行)

> **目标：** 手动补录企微数据，防止自动拉取遗漏，确保合规安全。
> **工具：** Apifox (或 Postman) 

### 🟣 企微会话存档数据补录

**📍 API 基础地址：** `http://172.17.10.202:8081`

| 序号       | 接口功能         | Method | URL                              | Header                                 | Body/Params                                                  | 预期结果                                 |
| ---------- | ---------------- | ------ | -------------------------------- | -------------------------------------- | ------------------------------------------------------------ | ---------------------------------------- |
| **Step 1** | **获取Token**    | POST   | `/api/user/login`                | 无                                     | Body: `username` & `password` (查api中ip上的DB获取，在sys_user表中) | 返回 JSON，`code=0`，复制 `access_token` |
| **Step 2** | **拉取客户信息** | POST   | `/api/wechat/customer/download`  | `Authorization: Bearer [Step1的token]` | 无                                                           | `code=0`                                 |
| **Step 3** | **拉取员工信息** | POST   | `/api/wechat/user/download`      | `Authorization: Bearer [Step1的token]` | 无                                                           | `code=0`                                 |
| **Step 4** | **拉取群聊信息** | POST   | `/api/wechat/groupchat/download` | `Authorization: Bearer [Step1的token]` | 无                                                           | `code=0`                                 |
| **Step 5** | **拉取聊天记录** | POST   | `/api/wechat/chatdata/download`  | `Authorization: Bearer [Step1的token]` | 无                                                           | `code=0`                                 |



> **💡 AI 进阶灵感：** 以后你可以写一个 Python 脚本，每周一自动执行这 5 步，并把结果发邮件给自己，替代手工操作。 
>
> 

## 第三部分：每两周任务 (周五下午建议执行)

> **目标：** 全量备份最核心的合规数据。 

### 🟣 企微会话存档备份

**📍 目标数据库：** `172.17.10.202` (MySQL), MinIO

| 对象               | 备份操作                       | 操作步骤                                                     |
| ------------------ | ------------------------------ | ------------------------------------------------------------ |
| **MySQL 数据库**   | **转储 SQL**                   | 1. 打开 Navicat，连接 `172.17.10.202`。 2. 右键数据库 `thqh_enterprise_wechat` -> **转储 SQL 文件**。 3. 自定义保存路径，不要只存在服务器上。 |
| **MinIO 文件对象** | **MC（MinIO Client）命令镜像** | 1. SSH 登录 `172.17.10.202`。 2. 执行备份命令，详细见下。    |

MinIO 数据库备份命令：

```sh
# 若还没安装mc工具，参考以下安装方式
wget https://dl.min.io/client/mc/release/linux-amd64/mc

# 赋予执行权限
chmod +x mc

# 移动到系统命令目录，方便全局使用
sudo mv mc /usr/local/bin/

------

# 格式：mc alias set [别名] MinIO服务地址 AccessKey SecretKey
mc alias set myminio-backup http://127.0.0.1:9000 minioadmin minioadmin

# 验证配置是否成功（列出所有存储桶）
mc ls myminio-backup

# 执行备份
mc myminio-backup/thqh-enterprise-wechat [备份转存目录]

# 查看备份的文件列表
ls -l [备份转存目录]

# 对比MinIO源和备份文件（校验一致性）
mc diff myminio-backup/thqh-enterprise-wechat [备份转存目录]

# 将备份的文件恢复到minIO
mc mirror [备份转存目录] myminio-backup/thqh-enterprise-wechat
```

